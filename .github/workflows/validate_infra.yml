name: Validate Infrastructure (Bicep)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '*.bicep'
      - '.github/workflows/validate-infra.yml'

jobs:
  validate-bicep:
    name: Validate Bicep Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "=== Setting up Azure CLI ==="
            az version
            echo "✅ Azure CLI ready"
            
      # 1. BASIC STRUCTURE VALIDATION
      - name: Validate Structure
        run: |
          echo "=== Validating Repository Structure ==="
          
          # Check required files
          echo "Checking required files..."
          if [ ! -f "main.bicep" ]; then
            echo "❌ main.bicep file is missing (required)"
            exit 1
          fi
          echo "✅ main.bicep exists"
          
          # Check environments directory
          if [ ! -d "environments" ]; then
            echo "❌ environments/ directory is missing"
            exit 1
          fi
          echo "✅ environments/ directory exists"
          
          # Check for at least one environment
          ENV_COUNT=$(find environments -maxdepth 1 -type d | wc -l)
          if [ $ENV_COUNT -le 1 ]; then
            echo "❌ No environment folders found in environments/"
            exit 1
          fi
          
      # 2. VALIDATE ENVIRONMENT CONFIGURATIONS
      - name: Validate Environment Configs
        run: |
          echo "=== Validating Environment Configurations ==="
          
          REQUIRED_ENVS=("dev" "staging" "prod")
          VALID_ENVS=0
          
          for env in "${REQUIRED_ENVS[@]}"; do
            echo "Checking environment: $env"
            
            if [ -d "environments/$env" ]; then
              echo "  ✅ Directory exists"
              
              # Check for main.bicepparam
              if [ -f "environments/$env/main.bicepparam" ]; then
                echo "  ✅ main.bicepparam exists"
                
                # Validate bicepparam syntax
                if grep -q "using 'main.bicep'" "environments/$env/main.bicepparam"; then
                  echo "  ✅ Valid using statement"
                else
                  echo "  ⚠️ Missing 'using' statement in main.bicepparam"
                fi
                
                VALID_ENVS=$((VALID_ENVS + 1))
              else
                echo "  ❌ main.bicepparam missing in environments/$env/"
              fi
              
              # Check for optional parameters.json
              if [ -f "environments/$env/parameters.json" ]; then
                echo "  ✅ parameters.json exists"
                
                # Validate JSON syntax
                if python3 -m json.tool "environments/$env/parameters.json" > /dev/null 2>&1; then
                  echo "  ✅ Valid JSON syntax"
                else
                  echo "  ❌ Invalid JSON syntax in parameters.json"
                fi
              fi
            else
              echo "  ❌ Directory missing"
            fi
            echo ""
          done
          
          if [ $VALID_ENVS -ge 1 ]; then
            echo "✅ Found $VALID_ENVS valid environment(s)"
          else
            echo "❌ No valid environments found with main.bicepparam files"
            exit 1
          fi
          
      # 3. LINT BICEP FILES
      - name: Lint Bicep files
        run: |
          echo "=== Linting Bicep Files ==="
          
          # Lint main template
          echo "Linting main.bicep..."
          az bicep lint --file main.bicep
          
          # Lint modules if they exist
          if [ -d "modules" ]; then
            echo "Linting modules..."
            for file in modules/*.bicep; do
              if [ -f "$file" ]; then
                echo "Linting: $(basename "$file")"
                az bicep lint --file "$file"
              fi
            done
          fi
          
          # Lint environment bicepparam files
          echo "Linting environment parameter files..."
          for bicepparam in $(find environments -name "*.bicepparam" -type f 2>/dev/null); do
            echo "Linting: $bicepparam"
            az bicep lint --file "$bicepparam"
          done
          
      # 4. BUILD VALIDATION - FIXED PARAMETERS FLAG
      - name: Build Bicep Validation
        run: |
          echo "=== Building Bicep Files ==="
          
          # Build main template
          echo "Building main.bicep..."
          az bicep build --file main.bicep --stdout > /dev/null
          echo "✅ main.bicep builds successfully"
          
          # Build modules
          if [ -d "modules" ]; then
            echo "Building modules..."
            for file in modules/*.bicep; do
              if [ -f "$file" ]; then
                az bicep build --file "$file" --stdout > /dev/null
                echo "✅ $(basename "$file") builds successfully"
              fi
            done
          fi
          
          # Test build with at least one environment
          echo "Testing build with environment parameters..."
          
          # Find first valid environment
          FIRST_ENV=$(find environments -name "main.bicepparam" -type f 2>/dev/null | head -1)
          if [ -n "$FIRST_ENV" ]; then
            echo "Testing with: $FIRST_ENV"
            
            # ✅ FIXED: For .bicepparam files, just pass the file directly
            az bicep build-params --file "$FIRST_ENV" --stdout > /dev/null
            echo "✅ Builds successfully with parameters"
          else
            echo "⚠️ No main.bicepparam files found to test parameterized build"
            
            # Try JSON parameters as fallback
            FIRST_JSON=$(find environments -name "parameters*.json" -type f 2>/dev/null | head -1)
            if [ -n "$FIRST_JSON" ]; then
              echo "Testing with JSON parameters: $FIRST_JSON"
              # ✅ FIXED: For JSON files, use @filename
              az bicep build-params --file "@$FIRST_JSON" --stdout > /dev/null
              echo "✅ Builds successfully with JSON parameters"
            fi
          fi
          
      # 5. SECURITY CHECKS
      - name: Security Checks
        run: |
          echo "=== Security Checks ==="
          
          # Check for hardcoded secrets (smart check ignoring comments)
          echo "Checking for hardcoded secrets..."
          python3 << 'EOF'
          import os
          import re
          
          def contains_hardcoded_secret(line):
              # Skip comments
              stripped = line.strip()
              if stripped.startswith('//') or stripped.startswith('#'):
                  return False
              
              # Patterns that indicate hardcoded secrets
              patterns = [
                  r'password\s*=\s*["\']',
                  r'secret\s*=\s*["\']',
                  r'key\s*=\s*["\']',
                  r'token\s*=\s*["\']',
                  r'connectionString\s*=\s*["\']',
              ]
              
              for pattern in patterns:
                  if re.search(pattern, line, re.IGNORECASE):
                      return True
              return False
          
          issues = []
          
          # Check Bicep files
          for root, dirs, files in os.walk('.'):
              if '.git' in root:
                  continue
                  
              for file in files:
                  if file.endswith('.bicep'):
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'r') as f:
                              for i, line in enumerate(f, 1):
                                  if contains_hardcoded_secret(line):
                                      issues.append(f"{filepath}:{i}: {line.strip()}")
                      except:
                          pass
          
          # Check JSON parameter files in environments
          env_path = os.path.join('.', 'environments')
          if os.path.exists(env_path):
              for root, dirs, files in os.walk(env_path):
                  for file in files:
                      if file.endswith('.json'):
                          filepath = os.path.join(root, file)
                          try:
                              with open(filepath, 'r') as f:
                                  content = f.read()
                                  # Look for hardcoded values in parameters
                                  if re.search(r'"value"\s*:\s*"[^"]*[Pp]assword[^"]*"', content):
                                      issues.append(f"{filepath}: Hardcoded password in parameters")
                                  if re.search(r'"value"\s*:\s*"[^"]*[Ss]ecret[^"]*"', content):
                                      issues.append(f"{filepath}: Hardcoded secret in parameters")
                          except:
                              pass
          
          if issues:
              print("❌ Hardcoded secrets found:")
              for issue in issues:
                  print(f"  - {issue}")
              exit(1)
          else:
              print("✅ No hardcoded secrets found")
          EOF