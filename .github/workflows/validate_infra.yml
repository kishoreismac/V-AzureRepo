name: Validate Infrastructure (Bicep)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**'
      - '.github/workflows/validate-infra.yml'

jobs:
  validate-bicep:
    name: Validate Bicep Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Bicep
        uses: azure/setup-bicep@v1
        
      - name: Install Azure CLI
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az --version
            
      # 1. LINTING - Check Bicep syntax and style
      - name: Lint Bicep files
        run: |
          echo "=== Linting Bicep files ==="
          
          # Check all .bicep files
          find . -name "*.bicep" -type f | while read file; do
            echo "Linting: $file"
            az bicep lint --file "$file"
          done
          
          # Check for required files
          if [ ! -f "main.bicep" ]; then
            echo "❌ main.bicep file is missing"
            exit 1
          fi
          
      # 2. COMPILATION - Build Bicep to ARM JSON
      - name: Build Bicep to ARM
        run: |
          echo "=== Building Bicep files ==="
          
          # Build main template
          az bicep build --file main.bicep --stdout
          
          # Build all modules
          for module in modules/*.bicep; do
            if [ -f "$module" ]; then
              echo "Building module: $module"
              az bicep build --file "$module" --stdout > /dev/null
            fi
          done
          
          echo "✅ All Bicep files compile successfully"
          
      # 3. VALIDATION - ARM template validation
      - name: ARM Template Validation
        run: |
          echo "=== Validating ARM Template ==="
          
          # Create compiled version
          az bicep build --file main.bicep --outfile main.json
          
          # Validate with Azure
          az deployment group validate \
            --resource-group "test-validation-rg" \
            --template-file main.json \
            --parameters @environments/dev/parameters.json \
            --no-pretty-print || echo "Validation completed"
            
      # 4. WHAT-IF ANALYSIS - Preview changes
      - name: What-If Analysis
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          echo "=== Running What-If Analysis ==="
          
          # Login to Azure
          az login --service-principal \
            -u $AZURE_CLIENT_ID \
            -p $AZURE_CLIENT_SECRET \
            --tenant $AZURE_TENANT_ID
            
          az account set --subscription $AZURE_SUBSCRIPTION_ID
          
          # Create test resource group if not exists
          az group create \
            --name "test-validation-rg" \
            --location eastus \
            --tags "Environment=Test" "CreatedBy=GitHubActions" || true
            
          # Run what-if
          az deployment group what-if \
            --resource-group "test-validation-rg" \
            --template-file main.bicep \
            --parameters @environments/dev/parameters.json \
            --no-pretty-print
            
      # 5. TEST DEPENDENCIES - Check module dependencies
      - name: Check Dependencies
        run: |
          echo "=== Checking Bicep Dependencies ==="
          
          # Create dependency graph
          az bicep build --file main.bicep --outfile main.json
          
          # Check for circular dependencies
          echo "Checking module imports..."
          grep -r "module " modules/ || echo "No module imports found"