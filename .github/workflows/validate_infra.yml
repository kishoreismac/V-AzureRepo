name: Validate Infrastructure (Bicep)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**'
      - '.github/workflows/validate-infra.yml'

jobs:
  validate-bicep:
    name: Validate Bicep Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ✅ FIXED: Add inlineScript parameter
      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "=== Setting up Azure CLI ==="
            az version
            echo "Bicep is included with Azure CLI"
            
      # 1. LINTING - Check Bicep syntax
      - name: Lint Bicep files
        run: |
          echo "=== Linting Bicep files ==="
          
          # Check if main.bicep exists
          if [ ! -f "main.bicep" ]; then
            echo "❌ main.bicep file is missing"
            exit 1
          fi
          
          # Lint main file
          echo "Linting main.bicep..."
          az bicep lint --file main.bicep
          
          # Lint modules if they exist
          if [ -d "modules" ]; then
            echo "Linting modules..."
            for file in modules/*.bicep; do
              if [ -f "$file" ]; then
                echo "Linting: $(basename "$file")"
                az bicep lint --file "$file"
              fi
            done
          fi
          
      # 2. COMPILATION - Build Bicep
      - name: Build Bicep to ARM
        run: |
          echo "=== Building Bicep files ==="
          
          # Build main template
          echo "Building main.bicep..."
          az bicep build --file main.bicep --stdout > /dev/null
          echo "✅ main.bicep builds successfully"
          
          # Build modules
          if [ -d "modules" ]; then
            echo "Building modules..."
            for file in modules/*.bicep; do
              if [ -f "$file" ]; then
                az bicep build --file "$file" --stdout > /dev/null
                echo "✅ $(basename "$file") builds successfully"
              fi
            done
          fi
          
      # 3. BASIC VALIDATION
      - name: Basic Validation
        run: |
          echo "=== Basic Validation ==="
          
          # Check required files
          echo "Checking required files..."
          
          REQUIRED_FILES=("main.bicep" "main.bicepparam")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file exists"
            else
              echo "❌ $file is missing"
              exit 1
            fi
          done
          
          # Check environment folders
          if [ -d "environments" ]; then
            echo "Checking environment configurations..."
            for env in dev staging prod; do
              if [ -d "environments/$env" ]; then
                echo "✅ Environment $env directory exists"
              else
                echo "⚠️ Environment $env directory missing"
              fi
            done
          fi
          
      # 4. HARDCODED VALUES CHECK
      - name: Check for Hardcoded Values
        run: |
          echo "=== Checking for Hardcoded Values ==="
          
          FOUND_ISSUES=0
          
          # Check for hardcoded secrets
          echo "Checking for hardcoded secrets..."
          PATTERNS=("password" "secret" "key" "token" "connectionString")
          
          for pattern in "${PATTERNS[@]}"; do
            RESULTS=$(grep -ri "$pattern" --include="*.bicep" --include="*.json" . 2>/dev/null | grep -v "test\|example\|demo\|placeholder\|@description" || true)
            
            if [ -n "$RESULTS" ]; then
              echo "❌ Found potential hardcoded '$pattern':"
              echo "$RESULTS" | head -3
              FOUND_ISSUES=1
            fi
          done
          
          if [ $FOUND_ISSUES -eq 0 ]; then
            echo "✅ No hardcoded values found"
          else
            echo "⚠️ Hardcoded values found. Use parameters instead."
            exit 1
          fi