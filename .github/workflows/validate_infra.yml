name: Validate Infrastructure (Bicep)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**'
      - '.github/workflows/validate-infra.yml'

jobs:
  validate-bicep:
    name: Validate Bicep Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ✅ UPDATED: Use Azure CLI action instead
      - name: Setup Azure CLI with Bicep
        uses: azure/CLI@v1
        with:
          inlineScript: |
            # Check Azure CLI version
            az version
            
            # Install Bicep if not present
            if ! command -v bicep &> /dev/null; then
              echo "Installing Bicep..."
              az bicep install
            fi
            
            # Verify Bicep installation
            bicep --version
            
      # 1. LINTING - Check Bicep syntax and style
      - name: Lint Bicep files
        run: |
          echo "=== Linting Bicep files ==="
          
          # Check all .bicep files
          find . -name "*.bicep" -type f | while read file; do
            echo "Linting: $file"
            bicep lint "$file"
          done
          
          # Check for required files
          if [ ! -f "main.bicep" ]; then
            echo "❌ main.bicep file is missing"
            exit 1
          fi
          
      # 2. COMPILATION - Build Bicep to ARM JSON
      - name: Build Bicep to ARM
        run: |
          echo "=== Building Bicep files ==="
          
          # Build main template
          bicep build main.bicep --stdout
          
          # Build all modules
          for module in modules/*.bicep; do
            if [ -f "$module" ]; then
              echo "Building module: $module"
              bicep build "$module" --stdout > /dev/null
            fi
          done
          
          echo "✅ All Bicep files compile successfully"
          
      # 3. VALIDATION - ARM template validation
      - name: ARM Template Validation
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "=== Validating ARM Template ==="
            
            # Create compiled version
            bicep build main.bicep --outfile main.json
            
            # Validate with Azure (requires login)
            echo "Skipping Azure validation (no credentials)"
            echo "To enable, add Azure login step"
            # az deployment group validate \
            #   --resource-group "test-validation-rg" \
            #   --template-file main.json \
            #   --parameters @environments/dev/parameters.json \
            #   --no-pretty-print || echo "Validation completed"
            
      # 4. WHAT-IF ANALYSIS (without Azure login)
      - name: Local What-If Analysis
        run: |
          echo "=== Running Local Analysis ==="
          
          # Check parameter files exist
          echo "Checking parameter files:"
          ls -la environments/ || echo "No environments directory"
          
          # Check for common issues
          echo "Checking for common Bicep issues:"
          
          # Check for hardcoded values
          if grep -r "hardcodedValue" . --include="*.bicep"; then
            echo "⚠️ Found potentially hardcoded values"
          fi
          
          # Check for missing descriptions
          echo "Checking for missing descriptions:"
          grep -n "@description" main.bicep || echo "No descriptions found"
          
      # 5. DEPENDENCY CHECK
      - name: Check Dependencies
        run: |
          echo "=== Checking Bicep Dependencies ==="
          
          # Create dependency graph
          bicep build main.bicep --outfile main.json
          
          # Check module imports
          echo "Module imports:"
          find modules -name "*.bicep" -exec grep -l "module " {} \; || echo "No module imports"