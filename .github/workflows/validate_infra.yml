name: Validate Infrastructure (Bicep)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**'
      - '.github/workflows/validate-infra.yml'

jobs:
  validate-bicep:
    name: Validate Bicep Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ✅ SIMPLIFIED: Just use Azure CLI - Bicep auto-installs
      - name: Setup Azure CLI
        uses: azure/CLI@v1
            
      # 1. LINTING - Check Bicep syntax and style (USE az bicep)
      - name: Lint Bicep files
        run: |
          echo "=== Linting Bicep files ==="
          
          # Check all .bicep files using az bicep
          find . -name "*.bicep" -type f | while read file; do
            echo "Linting: $file"
            az bicep lint --file "$file"
          done
          
          # Check for required files
          if [ ! -f "main.bicep" ]; then
            echo "❌ main.bicep file is missing"
            exit 1
          fi
          
      # 2. COMPILATION - Build Bicep to ARM JSON (USE az bicep)
      - name: Build Bicep to ARM
        run: |
          echo "=== Building Bicep files ==="
          
          # Build main template using az bicep
          az bicep build --file main.bicep --stdout
          
          # Build all modules
          for module in modules/*.bicep; do
            if [ -f "$module" ]; then
              echo "Building module: $module"
              az bicep build --file "$module" --stdout > /dev/null
            fi
          done
          
          echo "✅ All Bicep files compile successfully"
          
      # 3. BASIC VALIDATION
      - name: Basic Validation
        run: |
          echo "=== Basic Validation ==="
          
          # Create compiled version using az bicep
          az bicep build --file main.bicep --outfile main.json
          
          echo "✅ Compiled to ARM JSON: main.json"
          
          # Check file size
          echo "File size: $(wc -l < main.json) lines"
          
      # 4. LOCAL ANALYSIS
      - name: Local Analysis
        run: |
          echo "=== Running Local Analysis ==="
          
          # Check parameter files exist
          if [ -d "environments" ]; then
            echo "Checking parameter files:"
            find environments -name "*.json" -o -name "*.bicepparam"
          else
            echo "⚠️ No environments directory found"
          fi
          
          # Check for hardcoded values
          echo "Checking for hardcoded values..."
          if grep -ri "password\|secret\|key\|token" --include="*.bicep" --include="*.json" . 2>/dev/null | grep -v "test\|example\|demo\|placeholder"; then
            echo "⚠️ Found potentially sensitive values"
            exit 1
          fi
          
          echo "✅ No hardcoded values found"
          
      # 5. DEPENDENCY CHECK (USE az bicep)
      - name: Check Dependencies
        run: |
          echo "=== Checking Bicep Dependencies ==="
          
          # Create compiled version
          az bicep build --file main.bicep --outfile main.json
          
          # Check module imports
          echo "Module imports found in:"
          find . -name "*.bicep" -exec grep -l "module " {} \; 2>/dev/null || echo "No module imports found"