name: Infrastructure Security Scan

on:
  pull_request:
    branches: [main]
    paths:
      - '**'
      - '.github/workflows/security-scan.yml'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # ✅ Use Azure CLI instead of setup-bicep
      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az version
            az bicep install
            bicep --version
            
      # 1. CHECKOV - Infrastructure as Code Security
      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: false
          
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif
          
      # 2. BICEP-SPECIFIC SECURITY CHECKS
      - name: Bicep Security Scanner
        run: |
          echo "=== Bicep Security Checks ==="
          
          # Build Bicep
          bicep build main.bicep --outfile main.json
          
          # Run custom security checks
          python3 << 'EOF'
          import json
          import sys
          
          with open('main.json', 'r') as f:
              template = json.load(f)
          
          issues = []
          
          # Check for security issues
          for resource in template.get('resources', []):
              # Check for public access
              if 'publicNetworkAccess' in str(resource):
                  if 'Enabled' in str(resource):
                      issues.append('Public network access enabled')
              
              # Check for missing encryption
              if 'Microsoft.Storage/storageAccounts' in resource.get('type', ''):
                  if 'encryption' not in str(resource):
                      issues.append('Storage account missing encryption')
          
          if issues:
              print('⚠️ Security issues found:')
              for issue in issues:
                  print(f'  - {issue}')
              sys.exit(1)
          else:
              print('✅ No security issues found')
          EOF