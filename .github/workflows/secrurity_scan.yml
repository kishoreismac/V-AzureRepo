name: Infrastructure Security & Cost Scan

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/security-scan.yml'

jobs:
  security-cost-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # Setup Azure CLI
      - name: Setup Azure CLI
        uses: azure/CLI@v1
            
      # 1. CHECKOV SECURITY SCAN
      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: false
          
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif
          
      # 2. COST ANALYSIS (OPTIONAL - Requires Infracost API Key)
      - name: Setup Infracost
        if: github.event_name == 'pull_request' && secrets.INFRACOST_API_KEY != ''
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
          
      - name: Generate Infracost cost estimate
        if: github.event_name == 'pull_request' && secrets.INFRACOST_API_KEY != ''
        run: |
          echo "=== Cost Estimation with Infracost ==="
          
          # Generate cost breakdown
          infracost breakdown \
            --path . \
            --format json \
            --out-file infracost.json
          
          # Extract monthly cost
          ESTIMATED_COST=$(jq '.totalMonthlyCost' infracost.json)
          echo "Estimated monthly cost: $${ESTIMATED_COST}"
          
          # Simple budget check
          BUDGET=100
          if (( $(echo "$ESTIMATED_COST > $BUDGET" | bc -l) )); then
            echo "⚠️ Cost exceeds budget of $${BUDGET}. Consider optimizing."
          else
            echo "✅ Cost within reasonable range"
          fi
          
      # 3. BASIC SECURITY CHECKS (No external dependencies)
      - name: Bicep Security Scanner
        run: |
          echo "=== Bicep Security Checks ==="
          
          # Build Bicep
          az bicep build --file main.bicep --outfile main.json
          
          # Run Python security checks
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('main.json', 'r') as f:
                  template = json.load(f)
              
              issues = []
              
              for resource in template.get('resources', []):
                  resource_type = resource.get('type', '')
                  properties = resource.get('properties', {})
                  
                  # Storage account security
                  if 'Microsoft.Storage/storageAccounts' in resource_type:
                      if not properties.get('supportsHttpsTrafficOnly', True):
                          issues.append('Storage account allows HTTP traffic')
                      
                      if properties.get('minimumTlsVersion') != 'TLS1_2':
                          issues.append('Storage account should use TLS 1.2 minimum')
                      
                      if 'encryption' not in properties:
                          issues.append('Storage account missing encryption configuration')
                  
                  # Function App security
                  if 'Microsoft.Web/sites' in resource_type:
                      if not properties.get('httpsOnly', True):
                          issues.append('Function App should be HTTPS only')
                      
                      site_config = properties.get('siteConfig', {})
                      if site_config.get('minTlsVersion') != '1.2':
                          issues.append('Function App should use TLS 1.2 minimum')
              
              if issues:
                  print('⚠️ Security issues found:')
                  for issue in issues:
                      print(f'  - {issue}')
                  sys.exit(1)
              else:
                  print('✅ No security issues found')
                  
          except FileNotFoundError:
              print('❌ main.bicep not found or failed to build')
              sys.exit(1)
          except Exception as e:
              print(f'❌ Error: {e}')
              sys.exit(1)
          EOF
          
      # 4. HARDCODED SECRETS CHECK
      - name: Hardcoded Secrets Check
        run: |
          echo "=== Checking for Hardcoded Secrets ==="
          
          # Search for potential secrets
          FOUND_SECRETS=0
          
          # Check for common patterns
          patterns=(
            "password\\s*="
            "secret\\s*="
            "key\\s*="
            "token\\s*="
            "connectionString\\s*="
            "accountKey\\s*="
          )
          
          for pattern in "${patterns[@]}"; do
            results=$(grep -ri "$pattern" --include="*.bicep" --include="*.json" . 2>/dev/null | grep -v "test\|example\|demo\|placeholder" || true)
            
            if [ -n "$results" ]; then
              echo "❌ Found potential hardcoded secrets matching: $pattern"
              echo "$results"
              FOUND_SECRETS=1
            fi
          done
          
          if [ $FOUND_SECRETS -eq 0 ]; then
            echo "✅ No hardcoded secrets found"
          fi