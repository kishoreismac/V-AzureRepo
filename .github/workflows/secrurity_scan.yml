name: Infrastructure Security Scan

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/security-scan.yml'
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday at 9 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # 1. CHECKOV - Infrastructure as Code Security
      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: false
          quiet: false
          
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif
          
      # 2. AZURE SPECIFIC SECURITY CHECKS
      - name: Azure Security Scanner
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          echo "=== Azure Security Checks ==="
          
          # Create test parameters file
          cat > test-params.json <<EOF
          {
            "environment": "test",
            "location": "eastus",
            "tags": {
              "Environment": "Test",
              "SecurityScan": "true"
            }
          }
          EOF
          
          # Build Bicep to check configurations
          az bicep build --file main.bicep --outfile main.json
          
          # Check for common security issues
          echo "Checking for security issues..."
          
          # Publicly accessible resources
          if grep -q "\"publicNetworkAccess\": \"Enabled\"" main.json; then
            echo "‚ö†Ô∏è Warning: Public network access enabled"
          fi
          
          # Missing encryption
          if ! grep -q "encryption" main.json; then
            echo "‚ÑπÔ∏è Info: No encryption settings found"
          fi
          
          # Check NSG rules
          if grep -q "networkSecurityGroup" main.json; then
            echo "üîí NSG configuration found"
          fi
          
      # 3. COST ESTIMATION
      - name: Infrastructure Cost Estimation
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
          
      - name: Run Infracost
        run: |
          echo "=== Cost Estimation ==="
          
          # Generate cost breakdown
          infracost breakdown \
            --path . \
            --format json \
            --out-file infracost.json
            
          # Check against budget
          BUDGET=100  # Monthly budget in USD
          ESTIMATED_COST=$(jq '.totalMonthlyCost' infracost.json)
          
          echo "Estimated monthly cost: $${ESTIMATED_COST}"
          
          if (( $(echo "$ESTIMATED_COST > $BUDGET" | bc -l) )); then
            echo "‚ùå Cost exceeds budget of $${BUDGET}"
            exit 1
          else
            echo "‚úÖ Cost within budget"
          fi
          
      # 4. POLICY COMPLIANCE
      - name: Policy Compliance Check
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          echo "=== Policy Compliance ==="
          
          # Check against Azure Policy built-in definitions
          echo "Checking compliance with common policies..."
          
          # List of policies to check
          POLICIES=(
            "Allowed locations"
            "Allowed storage account SKUs"
            "Allowed virtual machine SKUs"
            "Audit storage accounts with no encryption"
          )
          
          for policy in "${POLICIES[@]}"; do
            echo "Checking: $policy"
          done