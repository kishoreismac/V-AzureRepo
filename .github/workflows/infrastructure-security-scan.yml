name: Infrastructure Security Scan

on:
  pull_request:
    branches: [ main, develop ]
  push:
    paths:
      - '**/*.bicep'
      - '.github/workflows/**'

permissions:
  contents: read
  id-token: write

jobs:
  security-scan:
    name: Static Security Scans (Checkov + Bicep lint)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Azure CLI (for bicep)
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az version || true
            if ! command -v bicep &> /dev/null; then
              az bicep install || true
            fi
            bicep --version || true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install tools (checkov, jq)
        run: |
          python -m pip install --upgrade pip
          pip install checkov==2.* || pip install checkov
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Build Bicep -> ARM JSON
        run: |
          if [ -f main.bicep ]; then
            az bicep build --file main.bicep --outfile main.json || { echo "Bicep build failed"; exit 1; }
          else
            echo "main.bicep not found, skipping build"
            exit 1
          fi

      - name: Lint Bicep files
        run: |
          for f in $(find . -name '*.bicep' -type f); do
            echo "Linting $f"
            bicep build "$f" --stdout > /dev/null || { echo "bicep build failed for $f"; exit 1; }
          done

      - name: Run Checkov against compiled ARM (main.json)
        id: checkov
        run: |
          checkov -f main.json -o json > checkov-report.json || true
          python - <<'PY'
import json,sys
r=json.load(open('checkov-report.json'))
fails=r.get('results',{}).get('failed_checks',[])
print("Checkov failed checks:", len(fails))
for f in fails:
    if f.get('severity','').upper() in ('HIGH','CRITICAL'):
        print("Found HIGH/CRITICAL check:", f)
        sys.exit(2)
if len(fails)>0:
    sys.exit(1)
PY

      - name: Upload security scan report
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report
          path: checkov-report.json

      - name: Notify summary
        if: failure()
        run: |
          echo "Security scan detected problems. Download checkov-report artifact from workflow run for details."
