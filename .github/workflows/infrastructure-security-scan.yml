name: Infrastructure Security Scan

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
    paths:
      - '*.bicep'
      - 'modules/**'
      - '.github/workflows/**'

permissions:
  contents: read
  id-token: write
  actions: read
  security-events: write  # Required for SARIF upload to Security tab

jobs:
  security-scan:
    name: Microsoft Security DevOps Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az version
            az bicep version || az bicep install

      #  Optional: Build Bicep to JSON for additional validation
      - name: Build Bicep files
        run: |
          echo "=== Building Bicep Files ==="
          
          if [ -f main.bicep ]; then
            az bicep build --file main.bicep --outfile main.json
            echo "‚úÖ main.bicep built successfully"
          fi
          
          # Build modules
          if [ -d modules ]; then
            for f in modules/*.bicep; do
              if [ -f "$f" ]; then
                echo "Building $(basename "$f")"
                az bicep build --file "$f" --stdout > /dev/null
              fi
            done
          fi

      # Lint Bicep files
      - name: Lint Bicep files
        continue-on-error: true
        run: |
          echo "=== Linting Bicep Files ==="
          
          for f in $(find . -name '*.bicep' -type f ! -path '*/.git/*'); do
            echo "Linting: $f"
            az bicep lint --file "$f" || true
          done

      # ========================================
      # MICROSOFT SECURITY DEVOPS - Main Scan
      # ========================================
      - name: Run Microsoft Security DevOps
        uses: microsoft/security-devops-action@latest
        id: msdo
        continue-on-error: true  # Don't fail workflow on security issues
        with:
          # Scan IaC and code categories
          categories: 'IaC,code'
          
          # Use Microsoft policy for enterprise standards
          policy: 'microsoft'

      # Upload results to GitHub Security tab - ALWAYS runs
      - name: Upload SARIF results to GitHub Security
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.msdo.outputs.sarifFile }}

      # Upload detailed results as artifact - ALWAYS runs
      - name: Upload scan results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: msdo-security-results
          path: ${{ steps.msdo.outputs.sarifFile }}
          retention-days: 30

      # ========================================
      # Analyze Results (Informational Only)
      # ========================================
      - name: Analyze Security Scan Results
        if: always()
        continue-on-error: true
        run: |
          echo "=== Analyzing Security Scan Results ==="
          
          # Check if SARIF file exists
          if [ ! -f "${{ steps.msdo.outputs.sarifFile }}" ]; then
            echo "‚ö†Ô∏è  No SARIF results found"
            exit 0
          fi
          
          # Install jq for JSON parsing
          sudo apt-get update -y && sudo apt-get install -y jq
          
          # Parse SARIF for high/critical issues
          CRITICAL_COUNT=$(jq '[.runs[].results[]? | select(.level == "error")] | length' "${{ steps.msdo.outputs.sarifFile }}" 2>/dev/null || echo "0")
          WARNING_COUNT=$(jq '[.runs[].results[]? | select(.level == "warning")] | length' "${{ steps.msdo.outputs.sarifFile }}" 2>/dev/null || echo "0")
          NOTE_COUNT=$(jq '[.runs[].results[]? | select(.level == "note")] | length' "${{ steps.msdo.outputs.sarifFile }}" 2>/dev/null || echo "0")
          
          echo ""
          echo "=== SECURITY SCAN FINDINGS ==="
          echo ""
          echo "  üî¥ Critical/High: $CRITICAL_COUNT"
          echo "  üü° Medium:        $WARNING_COUNT"
          echo "  üîµ Low/Info:      $NOTE_COUNT"
          echo ""
          
          # List critical issues (top 10)
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "Top Critical/High Severity Issues:"
            jq -r '.runs[].results[]? | select(.level == "error") | "  - \(.ruleId): \(.message.text)"' "${{ steps.msdo.outputs.sarifFile }}" 2>/dev/null | head -10
            echo ""
            
            if [ "$CRITICAL_COUNT" -gt 10 ]; then
              echo "  ... and $((CRITICAL_COUNT - 10)) more issue(s)"
              echo ""
            fi
          fi
          
          echo "‚ö†Ô∏è  These are informational findings"
          echo "üìä View all findings:"
          echo "  - GitHub Security tab ‚Üí Code scanning"
          echo "  - Download 'msdo-security-results' artifact"
          echo ""

      # ========================================
      # Final Summary (Always Success)
      # ========================================
      - name: Security Scan Summary
        if: always()
        run: |
          echo ""
          echo "=== SECURITY SCAN COMPLETE ‚úÖ ==="
          echo ""
          echo "Scanned with Microsoft Security DevOps:"
          echo "  ‚úÖ Checkov (IaC security)"
          echo "  ‚úÖ Template Analyzer (ARM/Bicep)"
          echo "  ‚úÖ Terrascan (IaC compliance)"
          echo "  ‚úÖ Bicep linting"
          echo ""
          echo "üìä Results uploaded to:"
          echo "  - GitHub Security tab (view in UI)"
          echo "  - Workflow artifacts (download SARIF)"
          echo ""
          echo "‚úÖ Workflow completed successfully"
          echo ""
          echo "Note: Security findings are informational and don't block deployment"