name: Infrastructure Lint & Build

on:
  pull_request:
    branches: [main, develop, feature/**]
    paths:
      - '*.bicep'
      - 'modules/**'
      - 'environments/**'
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  lint-and-build:
    name: Lint & Build Bicep
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Azure CLI & Bicep
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "=== Azure CLI & Bicep Setup ==="
            az version
            
            # Install/update Bicep
            if ! command -v bicep &> /dev/null; then
              echo "Installing Bicep..."
              az bicep install
            else
              echo "Updating Bicep..."
              az bicep upgrade
            fi
            
            echo "Bicep version:"
            az bicep version

      - name: Validate Bicep Configuration
        run: |
          echo "=== Validating Bicep Configuration ==="
          
          if [ -f bicepconfig.json ]; then
            echo "‚úÖ Found bicepconfig.json"
            echo "Configuration:"
            cat bicepconfig.json
          else
            echo "‚ö†Ô∏è  No bicepconfig.json found - using defaults"
          fi

      - name: Lint Main Bicep Template
        run: |
          echo "=== Linting Main Bicep Template ==="
          
          if [ -f main.bicep ]; then
            echo "Linting main.bicep..."
            if az bicep lint --file main.bicep; then
              echo "‚úÖ main.bicep linting passed"
            else
              echo "‚ùå main.bicep has linting errors"
              exit 1
            fi
          else
            echo "‚ùå main.bicep not found"
            exit 1
          fi

      - name: Lint Bicep Modules
        id: lint-modules
        continue-on-error: false
        run: |
          echo "=== Linting Bicep Modules ==="
          
          if [ ! -d modules ]; then
            echo "‚ÑπÔ∏è  No modules directory found"
            exit 0
          fi
          
          # Find all .bicep files in modules directory
          BICEP_FILES=$(find modules -name "*.bicep" -type f)
          
          if [ -z "$BICEP_FILES" ]; then
            echo "‚ÑπÔ∏è  No .bicep files found in modules directory"
            exit 0
          fi
          
          echo "Found $(echo "$BICEP_FILES" | wc -l) Bicep files to lint"
          
          LINT_ERRORS=0
          for file in $BICEP_FILES; do
            echo ""
            echo "Linting: $file"
            if az bicep lint --file "$file"; then
              echo "  ‚úÖ Passed"
            else
              echo "  ‚ùå Failed"
              LINT_ERRORS=$((LINT_ERRORS + 1))
            fi
          done
          
          if [ $LINT_ERRORS -gt 0 ]; then
            echo ""
            echo "‚ùå Found $LINT_ERRORS module linting errors"
            exit 1
          else
            echo ""
            echo "‚úÖ All modules passed linting"
          fi

      - name: Validate Environment Parameters
        id: validate-params
        continue-on-error: false
        run: |
          echo "=== Validating Environment Parameters ==="
          
          if [ ! -d environments ]; then
            echo "‚ÑπÔ∏è  No environments directory found"
            exit 0
          fi
          
          # Install yq for YAML parsing (if needed for other files)
          sudo apt-get update && sudo apt-get install -y jq
          
          # Check each environment directory
          PARAM_ERRORS=0
          for env_dir in environments/*/; do
            PARAM_FILE="${env_dir}main.bicepparam"
            
            if [ ! -f "$PARAM_FILE" ]; then
              echo "‚ö†Ô∏è  No parameter file in $(basename $env_dir)"
              continue
            fi
            
            echo ""
            echo "Checking: $(basename $env_dir)/main.bicepparam"
            
            # 1. File exists and is readable
            if [ ! -r "$PARAM_FILE" ]; then
              echo "  ‚ùå Cannot read parameter file"
              PARAM_ERRORS=$((PARAM_ERRORS + 1))
              continue
            fi
            
            # 2. Check for 'using' statement (Bicep parameter files start with this)
            if grep -q "^using " "$PARAM_FILE"; then
              USING_LINE=$(grep "^using " "$PARAM_FILE")
              echo "  ‚úÖ Contains 'using' statement"
              echo "     $USING_LINE"
              
              # Check if main.bicep exists relative to parameter file
              PARAM_DIR=$(dirname "$PARAM_FILE")
              RELATIVE_PATH=$(echo "$USING_LINE" | sed -n "s/.*using ['\"]\(.*\)['\"].*/\1/p")
              
              if [ -n "$RELATIVE_PATH" ]; then
                # Try to resolve the path
                RESOLVED_PATH=$(realpath -m "$PARAM_DIR/$RELATIVE_PATH" 2>/dev/null || echo "")
                if [ -f "$RESOLVED_PATH" ]; then
                  echo "  ‚úÖ Referenced file exists: $RELATIVE_PATH"
                else
                  echo "  ‚ö†Ô∏è  Referenced file may not exist: $RELATIVE_PATH"
                  echo "     Resolved path: $RESOLVED_PATH"
                fi
              fi
            else
              echo "  ‚ùå Missing 'using' statement (Bicep parameter files must start with 'using')"
              PARAM_ERRORS=$((PARAM_ERRORS + 1))
            fi
            
            # 3. Check for basic Bicep parameter syntax
            echo "  Checking parameter syntax..."
            
            # Count param statements
            PARAM_COUNT=$(grep -c "^param " "$PARAM_FILE" 2>/dev/null || echo "0")
            if [ "$PARAM_COUNT" -gt 0 ]; then
              echo "  ‚úÖ Contains $PARAM_COUNT parameter(s)"
            else
              echo "  ‚ö†Ô∏è  No 'param' statements found (might be empty or wrong format)"
            fi
            
            # 4. Show sample content (first 5 non-empty, non-comment lines)
            echo "  Sample content:"
            grep -v "^$" "$PARAM_FILE" | grep -v "^//" | head -5 | sed 's/^/     /'
            
            # 5. Check for common syntax errors
            # Check for unclosed quotes or brackets
            if grep -q '"[^"]*$' "$PARAM_FILE" || grep -q "'[^']*$" "$PARAM_FILE"; then
              echo "  ‚ö†Ô∏è  Possible unclosed quotes"
            fi
            
            # Check for valid assignment syntax
            INVALID_LINES=$(grep -n "^param.*=[^=]" "$PARAM_FILE" | grep -v "==" || true)
            if [ -n "$INVALID_LINES" ]; then
              echo "  ‚ö†Ô∏è  Check parameter assignment syntax on line(s):"
              echo "$INVALID_LINES" | sed 's/^/     /'
            fi
          done
          
          if [ $PARAM_ERRORS -gt 0 ]; then
            echo ""
            echo "‚ùå Found $PARAM_ERRORS parameter file errors"
            echo ""
            echo "üìù Bicep Parameter File Format Example:"
            echo "======================================="
            echo "using '../../main.bicep'"
            echo ""
            echo "param environmentName = 'dev'"
            echo "param location = 'eastus'"
            echo "param functionAppRuntime = 'python'"
            echo "// Add other parameters as needed"
            exit 1
          else
            echo ""
            echo "‚úÖ All parameter files have valid structure"
          fi

      - name: Build Bicep to ARM JSON
        id: build-bicep
        run: |
          echo "=== Building Bicep to ARM JSON ==="
          
          # Build main template
          echo "Building main.bicep..."
          if az bicep build --file main.bicep --outfile main.json; then
            echo "‚úÖ Successfully built main.json"
            
            # Show file info
            echo "Generated file size: $(wc -c < main.json) bytes"
            echo "Line count: $(wc -l < main.json) lines"
            
            # Install jq if not already installed
            if ! command -v jq &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y jq
            fi
            
            if command -v jq &> /dev/null; then
              RESOURCE_COUNT=$(jq '.resources | length' main.json 2>/dev/null || echo "0")
              echo "Resources in template: $RESOURCE_COUNT"
              
              # Show resource types
              echo "Resource types:"
              jq -r '.resources[].type' main.json 2>/dev/null | sort | uniq -c || echo "  (Could not parse)"
            fi
          else
            echo "‚ùå Failed to build main.bicep"
            exit 1
          fi

      - name: Validate Generated ARM Template
        run: |
          echo "=== Validating Generated ARM Template ==="
          
          if [ ! -f main.json ]; then
            echo "‚ùå main.json not found"
            exit 1
          fi
          
          # Install jq if not already installed
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Basic JSON validation
          if jq empty main.json 2>/dev/null; then
            echo "‚úÖ Valid JSON syntax"
          else
            echo "‚ùå Invalid JSON syntax"
            exit 1
          fi
          
          # Check for required ARM template fields
          REQUIRED_FIELDS=("\$schema" "contentVersion" "resources")
          MISSING_FIELDS=0
          
          for field in "${REQUIRED_FIELDS[@]}"; do
            if jq -e ".${field}" main.json >/dev/null 2>&1; then
              echo "‚úÖ Found required field: $field"
            else
              echo "‚ùå Missing required field: $field"
              MISSING_FIELDS=$((MISSING_FIELDS + 1))
            fi
          done
          
          if [ $MISSING_FIELDS -gt 0 ]; then
            echo "‚ùå Template missing $MISSING_FIELDS required fields"
            exit 1
          fi

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bicep-lint-build-results
          path: |
            main.json
          retention-days: 7

      - name: Lint Summary
        if: always()
        run: |
          echo ""
          echo "=== LINT & BUILD SUMMARY ==="
          echo ""
          echo "‚úÖ Bicep linting completed"
          echo "‚úÖ ARM template generated"
          echo "‚úÖ All validations passed"
          echo ""
          echo "üìä Outputs:"
          echo "  - Compiled ARM template: main.json"
          echo "  - Artifact: bicep-lint-build-results"
          echo ""
          echo "üöÄ Ready for security scanning and policy checks!"