name: Deploy to Development

on:
  workflow_run:
    workflows: ["PR Validation - All Checks"]  # âœ… ONLY ONE WORKFLOW
    types: [completed]
    branches: [develop]

permissions:
  id-token: write
  contents: read

env:
  ENVIRONMENT: dev
  LOCATION: eastus
  DEPLOYMENT_NAME: infra-dev-${{ github.run_id }}

jobs:
  # Check if validation gate actually succeeded
  check-validation:
    name: Check Validation Status
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - name: Check Validation Gate Result
        id: check
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "âœ… Validation gate passed"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Validation gate failed"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: check-validation
    if: needs.check-validation.outputs.should-deploy == 'true'
    environment: development
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          
      - name: Pre-deployment Validation
        run: |
          echo "=== Pre-deployment Validation ==="
          az bicep build --file main.bicep
          
          if [ ! -f "environments/${{ env.ENVIRONMENT }}/main.bicepparam" ]; then
            echo "âŒ Parameters file not found"
            exit 1
          fi
          
          echo "âœ… Validation passed"
          
      - name: What-If Deployment
        run: |
          echo "=== What-If Analysis ==="
          
          az deployment sub what-if \
            --name "${{ env.DEPLOYMENT_NAME }}-whatif" \
            --location "${{ env.LOCATION }}" \
            --template-file main.bicep \
            --parameters environments/${{ env.ENVIRONMENT }}/main.bicepparam \
            --no-pretty-print
            
      - name: Deploy Infrastructure
        run: |
          echo "=== Deploying Infrastructure ==="
          
          az deployment sub create \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --location "${{ env.LOCATION }}" \
            --template-file main.bicep \
            --parameters environments/${{ env.ENVIRONMENT }}/main.bicepparam \
            --only-show-errors
            
          echo "âœ… Deployment completed!"
          
      - name: Verify Monitoring Resources
        run: |
          echo "=== Verifying Monitoring Infrastructure ==="
          
          OUTPUTS=$(az deployment sub show \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --query properties.outputs \
            -o json)
          
          RESOURCE_GROUP=$(echo $OUTPUTS | jq -r '.RESOURCE_GROUP_NAME.value')
          LOG_WORKSPACE=$(echo $OUTPUTS | jq -r '.LOG_ANALYTICS_WORKSPACE_NAME.value // empty')
          APP_INSIGHTS=$(echo $OUTPUTS | jq -r '.APP_INSIGHTS_NAME.value // empty')
          
          # Only check if outputs exist
          if [ -n "$LOG_WORKSPACE" ]; then
            if az monitor log-analytics workspace show \
              --resource-group "$RESOURCE_GROUP" \
              --workspace-name "$LOG_WORKSPACE" &> /dev/null; then
              echo "âœ… Log Analytics Workspace deployed"
            else
              echo "âš ï¸  Log Analytics Workspace not found"
            fi
          fi
          
          if [ -n "$APP_INSIGHTS" ]; then
            if az monitor app-insights component show \
              --app "$APP_INSIGHTS" \
              --resource-group "$RESOURCE_GROUP" &> /dev/null; then
              echo "âœ… Application Insights deployed"
            else
              echo "âš ï¸  Application Insights not found"
            fi
          fi
          
      - name: Run Smoke Tests
        run: |
          echo "=== Running Smoke Tests ==="
          
          OUTPUTS=$(az deployment sub show \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --query properties.outputs \
            -o json)
          
          FUNCTION_APP_NAME=$(echo $OUTPUTS | jq -r '.AZURE_FUNCTION_NAME.value')
          STORAGE_NAME=$(echo $OUTPUTS | jq -r '.STORAGE_ACCOUNT_NAME.value')
          RESOURCE_GROUP=$(echo $OUTPUTS | jq -r '.RESOURCE_GROUP_NAME.value')
          
          echo "Checking deployed resources..."
          
          if az functionapp show --name "$FUNCTION_APP_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
            echo "âœ… Function App exists"
          else
            echo "âŒ Function App not found"
            exit 1
          fi
          
          if az storage account show --name "$STORAGE_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
            echo "âœ… Storage Account exists"
          else
            echo "âŒ Storage Account not found"
            exit 1
          fi
          
          echo "âœ… All smoke tests passed!"
          
      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "=== DEPLOYMENT SUMMARY ==="
          echo "âœ… Infrastructure deployed"
          echo "âœ… Monitoring infrastructure active"
          echo "âœ… Smoke tests passed"
          echo ""
          echo "ğŸš€ Deployment to ${{ env.ENVIRONMENT }} complete!"