name: Deploy to Development

on:
  push:
    branches: [develop]
    paths:
      - ./environments/dev/**
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch:  # Manual trigger

permissions:
  id-token: write
  contents: read

env:
  ENVIRONMENT: dev
  LOCATION: eastus
  DEPLOYMENT_NAME: infra-dev-${{ github.run_id }}

jobs:
  deploy:
    name: Deploy to Development
    runs-on: ubuntu-latest
    environment: development  # GitHub environment
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          
      # 1. PRE-DEPLOYMENT VALIDATION
      - name: Pre-deployment Validation
        run: |
          echo "=== Pre-deployment Validation ==="
          
          # Validate Bicep
          az bicep build --file main.bicep
          
          # Check parameter file exists
          if [ ! -f "environments/${{ env.ENVIRONMENT }}/main.bicepparam" ]; then
            echo "❌ Parameters file not found"
            exit 1
          fi
          
      # 2. WHAT-IF DEPLOYMENT
      - name: What-If Deployment
        run: |
          echo "=== What-If Analysis ==="
          
          az deployment sub what-if \
            --name "${{ env.DEPLOYMENT_NAME }}-whatif" \
            --location "${{ env.LOCATION }}" \
            --template-file main.bicep \
            --parameters @environments/${{ env.ENVIRONMENT }}/main.bicepparam \
            --no-pretty-print
            
      # 3. ACTUAL DEPLOYMENT
      - name: Deploy Infrastructure
        run: |
          echo "=== Deploying Infrastructure ==="
          
          az deployment sub create \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --location "${{ env.LOCATION }}" \
            --template-file main.bicep \
            --parameters @environments/${{ env.ENVIRONMENT }}/main.bicepparam \
            --only-show-errors
            
          echo "✅ Deployment completed!"
          
      # 4. POST-DEPLOYMENT SMOKE TESTS
      - name: Run Smoke Tests
        run: |
          echo "=== Running Smoke Tests ==="
          
          # Get outputs from deployment
          OUTPUTS=$(az deployment sub show \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --query properties.outputs \
            -o json)
          
          # Extract values
          FUNCTION_APP_NAME=$(echo $OUTPUTS | jq -r '.functionAppName.value')
          STORAGE_NAME=$(echo $OUTPUTS | jq -r '.storageAccountName.value')
          
          # Test resource existence
          echo "Checking deployed resources..."
          
          # Check Function App
          if az functionapp show --name $FUNCTION_APP_NAME --resource-group ${{ secrets.RESOURCE_GROUP_DEV }} &> /dev/null; then
            echo "✅ Function App exists"
          else
            echo "❌ Function App not found"
            exit 1
          fi
          
          # Check Storage Account
          if az storage account show --name $STORAGE_NAME --resource-group ${{ secrets.RESOURCE_GROUP_DEV }} &> /dev/null; then
            echo "✅ Storage Account exists"
          else
            echo "❌ Storage Account not found"
            exit 1
          fi
          
      # 5. CLEANUP TEST RESOURCES
      - name: Cleanup Test Resources
        if: always()
        run: |
          echo "=== Cleaning up test resources ==="
          
          # Delete test validation resource group
          az group delete \
            --name "test-validation-rg" \
            --yes \
            --no-wait || true