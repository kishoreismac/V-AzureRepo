name: Deploy to Development

on:
  workflow_run:
    workflows: ["Validate Infrastructure (Bicep)", "Infrastructure Security Scan", "Infrastructure Integration Tests"]
    types: [completed]
    branches: [develop]

permissions:
  id-token: write
  contents: read

env:
  ENVIRONMENT: dev
  LOCATION: eastus
  DEPLOYMENT_NAME: infra-dev-${{ github.run_id }}

jobs:
  deploy:
    name: Deploy to Development
    runs-on: ubuntu-latest
    environment: development  # GitHub environment
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          
      # 1. PRE-DEPLOYMENT VALIDATION
      - name: Pre-deployment Validation
        run: |
          echo "=== Pre-deployment Validation ==="
          
          # Validate Bicep
          az bicep build --file main.bicep
          
          # Check parameter file exists
          if [ ! -f "environments/${{ env.ENVIRONMENT }}/main.bicepparam" ]; then
            echo "❌ Parameters file not found"
            exit 1
          fi
          
      # 2. WHAT-IF DEPLOYMENT
      - name: What-If Deployment
        run: |
          echo "=== What-If Analysis ==="
          
          az deployment sub what-if \
            --name "${{ env.DEPLOYMENT_NAME }}-whatif" \
            --location "${{ env.LOCATION }}" \
            --template-file main.bicep \
            --parameters environments/${{ env.ENVIRONMENT }}/main.bicepparam \
            --no-pretty-print
            
      # 3. ACTUAL DEPLOYMENT
      - name: Deploy Infrastructure
        run: |
          echo "=== Deploying Infrastructure ==="
          
          az deployment sub create \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --location "${{ env.LOCATION }}" \
            --template-file main.bicep \
            --parameters environments/${{ env.ENVIRONMENT }}/main.bicepparam \
            --only-show-errors
            
          echo "✅ Deployment completed!"
          
            
      - name: Run Smoke Tests
        run: |
          echo "=== Running Smoke Tests ==="
          
          # Get outputs from deployment
          OUTPUTS=$(az deployment sub show \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --query properties.outputs \
            -o json)
          
          # Extract values using CORRECT output names
          FUNCTION_APP_NAME=$(echo $OUTPUTS | jq -r '.AZURE_FUNCTION_NAME.value')
          STORAGE_NAME=$(echo $OUTPUTS | jq -r '.STORAGE_ACCOUNT_NAME.value')
          RESOURCE_GROUP=$(echo $OUTPUTS | jq -r '.RESOURCE_GROUP_NAME.value')
          
          echo "Checking deployed resources..."
          
          # Check Function App
          if az functionapp show --name "$FUNCTION_APP_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
            echo "✅ Function App exists"
          else
            echo "❌ Function App not found"
            exit 1
          fi
          
          # Check Storage Account
          if az storage account show --name "$STORAGE_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
            echo "✅ Storage Account exists"
          else
            echo "❌ Storage Account not found"
            exit 1
          fi
          
          echo "✅ Smoke tests passed!"
          
      # 4. POST-DEPLOY MONITORING CONFIGURATION
      - name: Configure Monitoring
        run: |
          echo "=== Configuring Post-Deploy Monitoring ==="
          
          # Make script executable
          chmod +x scripts/configure-monitoring.sh
          
          # Get deployment outputs
          OUTPUTS=$(az deployment sub show \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --query properties.outputs \
            -o json)
          
          RESOURCE_GROUP=$(echo $OUTPUTS | jq -r '.RESOURCE_GROUP_NAME.value')
          FUNCTION_APP_NAME=$(echo $OUTPUTS | jq -r '.AZURE_FUNCTION_NAME.value')
          LOG_ANALYTICS_NAME=$(echo $OUTPUTS | jq -r '.LOG_ANALYTICS_NAME.value')
          APP_INSIGHTS_NAME=$(echo $OUTPUTS | jq -r '.APPLICATION_INSIGHTS_NAME.value')
          
          # Run monitoring configuration script
          ./scripts/configure-monitoring.sh \
            --resource-group "$RESOURCE_GROUP" \
            --function-app "$FUNCTION_APP_NAME" \
            --log-analytics "$LOG_ANALYTICS_NAME" \
            --app-insights "$APP_INSIGHTS_NAME" \
            --environment "${{ env.ENVIRONMENT }}"
          
          echo "✅ Monitoring configured!"