name: Deploy to Development

on:
  workflow_run:
    workflows: ["Validate Infrastructure (Bicep)", "Infrastructure Security Scan", "Infrastructure Integration Tests"]
    types: [completed]
    branches: [main, develop]

permissions:
  id-token: write
  contents: read

env:
  ENVIRONMENT: dev
  LOCATION: eastus
  DEPLOYMENT_NAME: infra-dev-${{ github.run_id }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    
    env:
      DEPLOYMENT_NAME: deploy-$(date +%Y%m%d-%H%M%S)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Run What-If
        run: |
          az deployment sub what-if \
            --location eastus \
            --template-file main.bicep \
            --parameters environments/dev/main.bicepparam
            
      - name: Deploy Infrastructure
        run: |
          az deployment sub create \
            --location eastus \
            --template-file main.bicep \
            --parameters environments/dev/main.bicepparam \
            --name "${{ env.DEPLOYMENT_NAME }}"
            
      - name: Run Smoke Tests
        run: |
          echo "=== Running Smoke Tests ==="
          
          # Get outputs from deployment
          OUTPUTS=$(az deployment sub show \
            --name "${{ env.DEPLOYMENT_NAME }}" \
            --query properties.outputs \
            -o json)
          
          # Extract values using CORRECT output names
          FUNCTION_APP_NAME=$(echo $OUTPUTS | jq -r '.AZURE_FUNCTION_NAME.value')
          STORAGE_NAME=$(echo $OUTPUTS | jq -r '.STORAGE_ACCOUNT_NAME.value')
          RESOURCE_GROUP=$(echo $OUTPUTS | jq -r '.RESOURCE_GROUP_NAME.value')
          
          echo "Checking deployed resources..."
          
          # Check Function App
          if az functionapp show --name "$FUNCTION_APP_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
            echo "✅ Function App exists"
          else
            echo "❌ Function App not found"
            exit 1
          fi
          
          # Check Storage Account
          if az storage account show --name "$STORAGE_NAME" --resource-group "$RESOURCE_GROUP" &> /dev/null; then
            echo "✅ Storage Account exists"
          else
            echo "❌ Storage Account not found"
            exit 1
          fi
          
          echo "✅ Smoke tests passed!"