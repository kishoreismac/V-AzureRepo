name: Infrastructure Security Scan

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**'
      - '.github/workflows/security_scan.yml'
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # Setup Azure CLI
      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "Setting up Azure CLI for security scan"
            az version
            echo "‚úÖ Azure CLI ready"
            
      # 1. CHECKOV SECURITY SCAN
      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: false
          quiet: true
          
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif
          
      # 2. BASIC SECURITY CHECKS
      - name: Bicep Security Scanner
        run: |
          echo "=== Bicep Security Checks ==="
          
          # Check if main.bicep exists
          if [ ! -f "main.bicep" ]; then
            echo "‚ÑπÔ∏è main.bicep not found, skipping detailed checks"
            exit 0
          fi
          
          # Build Bicep
          echo "Building main.bicep..."
          az bicep build --file main.bicep --outfile main.json
          
          # Run Python security checks
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('main.json', 'r') as f:
                  template = json.load(f)
              
              issues = []
              warnings = []
              
              for resource in template.get('resources', []):
                  resource_type = resource.get('type', '')
                  properties = resource.get('properties', {})
                  
                  # Storage account security
                  if 'Microsoft.Storage/storageAccounts' in resource_type:
                      if not properties.get('supportsHttpsTrafficOnly', True):
                          issues.append('Storage account allows HTTP traffic')
                      
                      if properties.get('minimumTlsVersion') != 'TLS1_2':
                          warnings.append('Storage account should use TLS 1.2 minimum')
                      
                      if 'encryption' not in properties:
                          warnings.append('Storage account missing encryption configuration')
                      
                      network_acls = properties.get('networkAcls', {})
                      if network_acls.get('defaultAction') == 'Allow':
                          issues.append('Storage account network default action should be Deny')
                  
                  # Function App security
                  if 'Microsoft.Web/sites' in resource_type:
                      if not properties.get('httpsOnly', True):
                          issues.append('Function App should be HTTPS only')
                      
                      site_config = properties.get('siteConfig', {})
                      if site_config.get('minTlsVersion') != '1.2':
                          warnings.append('Function App should use TLS 1.2 minimum')
              
              if warnings:
                  print('‚ö†Ô∏è Security warnings (should fix):')
                  for warning in warnings:
                      print(f'  - {warning}')
              
              if issues:
                  print('‚ùå Critical security issues (must fix):')
                  for issue in issues:
                      print(f'  - {issue}')
                  sys.exit(1)
              else:
                  if warnings:
                      print('‚úÖ No critical issues, but consider fixing warnings above')
                  else:
                      print('‚úÖ All security checks passed')
                  
          except FileNotFoundError:
              print('‚ùå main.bicep not found or failed to build')
              sys.exit(1)
          except Exception as e:
              print(f'‚ùå Error during security check: {e}')
              sys.exit(1)
          EOF
          
      # 3. SMART HARDCODED SECRETS CHECK (Ignores comments)
      - name: Check for Hardcoded Secrets
        run: |
          echo "=== Smart Hardcoded Secrets Check ==="
          echo "Checking for actual hardcoded values (ignoring comments)..."
          
          REAL_ISSUES=0
          
          # Check Bicep files for actual assignments, not comments
          echo "Checking Bicep files..."
          for file in $(find . -name "*.bicep" -type f 2>/dev/null); do
            echo "Checking: $file"
            
            # Remove comment lines and check remaining
            TEMP_FILE=$(mktemp)
            # Remove single line comments
            grep -v '^\s*//' "$file" | grep -v '^\s*#' > "$TEMP_FILE"
            
            # Check for actual assignments
            if grep -i 'password\s*=\s*"[^"]*"' "$TEMP_FILE"; then
              echo "‚ùå Found hardcoded password assignment in: $file"
              grep -n -i 'password\s*=\s*"[^"]*"' "$file"
              REAL_ISSUES=1
            fi
            
            if grep -i 'secret\s*=\s*"[^"]*"' "$TEMP_FILE"; then
              echo "‚ùå Found hardcoded secret assignment in: $file"
              grep -n -i 'secret\s*=\s*"[^"]*"' "$file"
              REAL_ISSUES=1
            fi
            
            if grep -i 'key\s*=\s*"[^"]*"' "$TEMP_FILE" | grep -v 'PrimaryKey\|SecondaryKey'; then
              echo "‚ùå Found hardcoded key assignment in: $file"
              grep -n -i 'key\s*=\s*"[^"]*"' "$file" | grep -v 'PrimaryKey\|SecondaryKey'
              REAL_ISSUES=1
            fi
            
            rm "$TEMP_FILE"
          done
          
          # Check JSON parameter files
          echo "Checking parameter files..."
          for file in $(find . -path ./environments -name "*.json" -type f 2>/dev/null); do
            echo "Checking: $file"
            
            # Look for hardcoded values in parameters
            if grep -i '"value"\s*:\s*"[^"]*[Pp]assword[^"]*"' "$file"; then
              echo "‚ùå Found hardcoded password in parameter file: $file"
              grep -n -i '"value".*[Pp]assword' "$file"
              REAL_ISSUES=1
            fi
            
            if grep -i '"value"\s*:\s*"[^"]*[Ss]ecret[^"]*"' "$file"; then
              echo "‚ùå Found hardcoded secret in parameter file: $file"
              grep -n -i '"value".*[Ss]ecret' "$file"
              REAL_ISSUES=1
            fi
            
            if grep -i '"value"\s*:\s*"[^"]*[Kk]ey[^"]*"' "$file" | grep -v 'PrimaryKey\|SecondaryKey'; then
              echo "‚ùå Found hardcoded key in parameter file: $file"
              grep -n -i '"value".*[Kk]ey' "$file" | grep -v 'PrimaryKey\|SecondaryKey'
              REAL_ISSUES=1
            fi
          done
          
          if [ $REAL_ISSUES -eq 0 ]; then
            echo "‚úÖ No actual hardcoded secrets found"
            echo "‚ÑπÔ∏è Comments about 'token' or 'key' are not actual secrets"
          else
            echo "‚ùå Actual hardcoded values found. Use parameters or Azure Key Vault."
            exit 1
          fi
          
      # 4. COST AWARENESS CHECK (No external dependencies)
      - name: Cost Awareness Check
        run: |
          echo "=== Cost Awareness Check ==="
          
          if [ ! -f "main.bicep" ]; then
            echo "‚ÑπÔ∏è main.bicep not found, skipping cost check"
            exit 0
          fi
          
          # Build to check for expensive resources
          az bicep build --file main.bicep --outfile main.json
          
          echo "Checking for potentially expensive resources..."
          
          # Use Python for better analysis
          python3 << 'EOF'
          import json
          
          expensive_skus = {
              'Standard_D4s_v3': 'Consider D2s_v3 for non-production',
              'Standard_D8s_v3': 'Consider D4s_v3 for non-production',
              'P1V2': 'Consider P1V1 for development',
              'P2V2': 'Consider P1V2 for staging',
              'P3V2': 'Consider lower tier for non-critical workloads',
              'Premium_LRS': 'Consider Standard_LRS for non-critical data',
              'Standard_GRS': 'Consider LRS for non-critical, non-backup data'
          }
          
          try:
              with open('main.json', 'r') as f:
                  template = json.load(f)
              
              cost_warnings = []
              
              for resource in template.get('resources', []):
                  sku = resource.get('sku', {})
                  sku_name = sku.get('name', '')
                  resource_type = resource.get('type', '')
                  
                  if sku_name in expensive_skus:
                      cost_warnings.append(f"{resource_type}: SKU {sku_name} - {expensive_skus[sku_name]}")
                  
                  # Check for premium features
                  properties = resource.get('properties', {})
                  if 'zoneRedundant' in str(properties) and 'true' in str(properties):
                      cost_warnings.append(f"{resource_type}: Zone redundancy increases cost (good for HA)")
                  
                  if 'geoRedundant' in str(properties) and 'true' in str(properties):
                      cost_warnings.append(f"{resource_type}: Geo-redundancy increases cost (good for DR)")
              
              if cost_warnings:
                  print("‚ö†Ô∏è Cost considerations:")
                  for warning in cost_warnings:
                      print(f"  - {warning}")
                  print("\n‚ÑπÔ∏è For detailed cost analysis, add INFRACOST_API_KEY to secrets")
              else:
                  print("‚úÖ No obvious expensive resources detected")
                  
          except Exception as e:
              print(f"‚ÑπÔ∏è Cost check note: {e}")
          EOF
          
      # 5. FINAL SUMMARY
      - name: Security Scan Summary
        if: always()
        run: |
          echo "=== SECURITY SCAN SUMMARY ==="
          echo "‚úÖ Checkov scan completed (results uploaded)"
          echo "‚úÖ Bicep security checks completed"
          echo "‚úÖ Hardcoded secrets check completed"
          echo "‚úÖ Cost awareness check completed"
          echo ""
          echo "üìä All security checks have been executed."
          echo "Check the 'Security' tab for detailed Checkov findings."
          echo ""
          echo "Next steps:"
          echo "1. Review Checkov findings in GitHub Security tab"
          echo "2. Fix any critical security issues"
          echo "3. Consider cost optimization suggestions"
          echo "4. For production, add INFRACOST_API_KEY for detailed cost analysis"