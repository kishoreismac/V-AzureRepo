name: Infrastructure Security & Cost Scan

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'infra/**'
      - '.github/workflows/security_scan.yml'
  workflow_dispatch:

jobs:
  security-cost-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write  # Required for Infracost comments
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # Setup Azure CLI
      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "Setting up Azure CLI"
            az version
            echo "‚úÖ Azure CLI ready"
            
      # 1. CHECKOV SECURITY SCAN
      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
          quiet: true
          
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif
          
      # 2. INFRACOST COST ANALYSIS
      - name: Setup Infracost
        if: github.event_name == 'pull_request'
        id: setup-infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY || '' }}
          
      - name: Generate Infracost Report
        if: github.event_name == 'pull_request' && secrets.INFRACOST_API_KEY != ''
        id: infracost-report
        run: |
          echo "=== Infracost Detailed Cost Analysis ==="
          
          # Generate cost breakdown
          infracost breakdown \
            --path . \
            --format json \
            --out-file infracost.json
          
          # Show summary
          echo "Cost Summary:"
          infracost output --path infracost.json --format table
          
          # Check budget
          BUDGET=100
          ESTIMATED_COST=$(jq '.totalMonthlyCost' infracost.json)
          
          echo ""
          echo "Estimated monthly cost: $${ESTIMATED_COST}"
          echo "Budget limit: $${BUDGET}"
          
          if (( $(echo "$ESTIMATED_COST > $BUDGET" | bc -l) )); then
            echo "‚ùå Cost exceeds budget!"
            echo "infracost-status=over-budget" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Cost within budget"
            echo "infracost-status=within-budget" >> $GITHUB_OUTPUT
          fi
          
      - name: Post Infracost Comment to PR
        if: github.event_name == 'pull_request' && secrets.INFRACOST_API_KEY != ''
        run: |
          echo "=== Posting Infracost Comment to PR ==="
          
          # Post comment using CLI (NOT composite action)
          infracost comment github \
            --path infracost.json \
            --repo ${{ github.repository }} \
            --pull-request ${{ github.event.pull_request.number }} \
            --github-token ${{ secrets.GITHUB_TOKEN }} \
            --behavior update
          
      # 3. BASIC COST CHECK (if Infracost not available)
      - name: Basic Cost Awareness Check
        if: github.event_name == 'pull_request' && ${{ secrets.INFRACOST_API_KEY }} == ''
        run: |
          echo "=== Basic Cost Awareness Check ==="
          echo "‚ÑπÔ∏è INFRACOST_API_KEY not set. Using basic cost check."
          
          if [ ! -f "main.bicep" ]; then
            echo "‚ÑπÔ∏è main.bicep not found"
            exit 0
          fi
          
          az bicep build --file main.bicep --outfile main.json
          
          python3 << 'EOF'
          import json
          
          expensive_skus = {
              'Standard_D4s_v3': 'Consider D2s_v3 for non-production',
              'Standard_D8s_v3': 'Consider D4s_v3 for non-production',
              'P1V2': 'Consider P1V1 for development',
              'P2V2': 'Consider P1V2 for staging',
              'P3V2': 'Consider lower tier for non-critical workloads',
              'Premium_LRS': 'Consider Standard_LRS for non-critical data',
              'Standard_GRS': 'Consider LRS for non-critical, non-backup data'
          }
          
          try:
              with open('main.json', 'r') as f:
                  template = json.load(f)
              
              warnings = []
              
              for resource in template.get('resources', []):
                  sku = resource.get('sku', {})
                  sku_name = sku.get('name', '')
                  resource_type = resource.get('type', '')
                  
                  if sku_name in expensive_skus:
                      warnings.append(f"{resource_type}: {expensive_skus[sku_name]}")
              
              if warnings:
                  print("‚ö†Ô∏è Cost optimization suggestions:")
                  for warning in warnings:
                      print(f"  - {warning}")
                  print("\n‚ÑπÔ∏è For accurate cost estimation, add INFRACOST_API_KEY to secrets")
              else:
                  print("‚úÖ No obvious expensive SKUs detected")
                  
          except Exception as e:
              print(f"Note: {e}")
          EOF
          
      # 4. BASIC SECURITY CHECKS
      - name: Bicep Security Scanner
        run: |
          echo "=== Bicep Security Checks ==="
          
          if [ ! -f "main.bicep" ]; then
            echo "‚ÑπÔ∏è main.bicep not found"
            exit 0
          fi
          
          echo "Building main.bicep..."
          az bicep build --file main.bicep --outfile main.json
          
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('main.json', 'r') as f:
                  template = json.load(f)
              
              issues = []
              warnings = []
              
              for resource in template.get('resources', []):
                  resource_type = resource.get('type', '')
                  properties = resource.get('properties', {})
                  
                  if 'Microsoft.Storage/storageAccounts' in resource_type:
                      if not properties.get('supportsHttpsTrafficOnly', True):
                          issues.append('Storage account allows HTTP traffic')
                      
                      network_acls = properties.get('networkAcls', {})
                      if network_acls.get('defaultAction') == 'Allow':
                          issues.append('Storage account network default action should be Deny')
                  
                  if 'Microsoft.Web/sites' in resource_type:
                      if not properties.get('httpsOnly', True):
                          issues.append('Function App should be HTTPS only')
              
              if issues:
                  print('‚ùå Critical security issues:')
                  for issue in issues:
                      print(f'  - {issue}')
                  sys.exit(1)
              else:
                  print('‚úÖ No critical security issues found')
                  
          except Exception as e:
              print(f"Note: {e}")
          EOF
          
      # 5. SMART HARDCODED SECRETS CHECK
      - name: Check for Hardcoded Secrets
        run: |
          echo "=== Hardcoded Secrets Check ==="
          
          python3 << 'EOF'
          import os
          import re
          
          def check_file(filepath):
              issues = []
              try:
                  with open(filepath, 'r') as f:
                      lines = f.readlines()
                  
                  for i, line in enumerate(lines, 1):
                      # Skip comments
                      stripped = line.strip()
                      if stripped.startswith('//') or stripped.startswith('#'):
                          continue
                      
                      # Check for hardcoded secrets
                      patterns = [
                          (r'password\s*=\s*["\']', 'Hardcoded password'),
                          (r'secret\s*=\s*["\']', 'Hardcoded secret'),
                          (r'key\s*=\s*["\']', 'Hardcoded key'),
                          (r'token\s*=\s*["\']', 'Hardcoded token'),
                      ]
                      
                      for pattern, desc in patterns:
                          if re.search(pattern, line, re.IGNORECASE):
                              issues.append(f"Line {i}: {desc}")
              
              except Exception as e:
                  pass
              
              return issues
          
          all_issues = []
          
          # Check Bicep files
          for root, dirs, files in os.walk('.'):
              if '.git' in dirs:
                  dirs.remove('.git')
              
              for file in files:
                  if file.endswith('.bicep'):
                      filepath = os.path.join(root, file)
                      issues = check_file(filepath)
                      if issues:
                          all_issues.append((filepath, issues))
          
          # Check JSON parameter files
          if os.path.exists('environments'):
              for root, dirs, files in os.walk('environments'):
                  for file in files:
                      if file.endswith('.json'):
                          filepath = os.path.join(root, file)
                          
                          try:
                              with open(filepath, 'r') as f:
                                  content = f.read()
                              
                              # Look for hardcoded values
                              if re.search(r'"value"\s*:\s*"[^"]*[Pp]assword[^"]*"', content):
                                  all_issues.append((filepath, ["Hardcoded password in parameters"]))
                              
                              if re.search(r'"value"\s*:\s*"[^"]*[Ss]ecret[^"]*"', content):
                                  all_issues.append((filepath, ["Hardcoded secret in parameters"]))
                          
                          except Exception:
                              pass
          
          if all_issues:
              print("‚ùå Hardcoded values found:")
              for filepath, issues in all_issues:
                  print(f"\nFile: {filepath}")
                  for issue in issues:
                      print(f"  - {issue}")
              print("\nUse parameters or Key Vault instead.")
              exit(1)
          else:
              print("‚úÖ No hardcoded secrets found")
          EOF
          
      # 6. FINAL SUMMARY
      - name: Security & Cost Scan Summary
        if: always()
        run: |
          echo "=== SECURITY & COST SCAN SUMMARY ==="
          echo ""
          echo "üîí Security:"
          echo "  ‚úÖ Checkov scan completed (view in Security tab)"
          echo "  ‚úÖ Custom security checks completed"
          echo "  ‚úÖ Hardcoded secrets check completed"
          echo ""
          echo "üí∞ Cost Analysis:"
          if [ "${{ secrets.INFRACOST_API_KEY != '' }}" ] && [ "${{ github.event_name == 'pull_request' }}" ]; then
            echo "  ‚úÖ Infracost detailed analysis completed"
            echo "  ‚úÖ PR comment with cost breakdown posted"
            echo "  ‚úÖ Budget check performed"
          else
            echo "  ‚úÖ Basic cost awareness check completed"
            echo "  ‚ÑπÔ∏è Add INFRACOST_API_KEY to secrets for detailed analysis"
          fi
          echo ""
          echo "üìä All checks completed successfully!"