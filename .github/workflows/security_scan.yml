name: Infrastructure Security Scan

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**'
      - '.github/workflows/security_scan.yml'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # Setup Azure CLI
      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          inlineScript: echo "Azure CLI ready"
            
      # 1. CHECKOV SECURITY SCAN
      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./
          framework: bicep
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
          quiet: false
          
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif
          
      # 2. COST ANALYSIS (Simplified - no secrets in condition)
      - name: Setup Infracost
        if: github.event_name == 'pull_request'
        id: setup-infracost
        run: |
          echo "=== Setting up Infracost ==="
          
          # Check if API key is available
          if [ -n "${{ secrets.INFRACOST_API_KEY }}" ]; then
            echo "INFRACOST_API_KEY is set"
            
            # Install Infracost
            curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
            export PATH="$PATH:$HOME/.infracost"
            
            # Set API key
            infracost configure set api_key ${{ secrets.INFRACOST_API_KEY }}
            echo "infracost-setup=true" >> $GITHUB_OUTPUT
          else
            echo "INFRACOST_API_KEY not set. Skipping detailed cost analysis."
            echo "infracost-setup=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate Infracost cost estimate
        if: steps.setup-infracost.outputs.infracost-setup == 'true'
        run: |
          echo "=== Cost Estimation with Infracost ==="
          
          # Generate cost breakdown
          infracost breakdown \
            --path . \
            --format json \
            --out-file infracost.json
          
          # Extract monthly cost
          ESTIMATED_COST=$(jq '.totalMonthlyCost' infracost.json)
          echo "Estimated monthly cost: $${ESTIMATED_COST}"
          
          # Simple budget check
          BUDGET=100
          if (( $(echo "$ESTIMATED_COST > $BUDGET" | bc -l) )); then
            echo "⚠️ Cost exceeds budget of $${BUDGET}. Consider optimizing."
          else
            echo "✅ Cost within reasonable range"
          fi
          
      # 3. BASIC SECURITY CHECKS
      - name: Bicep Security Scanner
        run: |
          echo "=== Bicep Security Checks ==="
          
          # Check if main.bicep exists
          if [ ! -f "main.bicep" ]; then
            echo "❌ main.bicep not found"
            exit 1
          fi
          
          # Build Bicep
          az bicep build --file main.bicep --outfile main.json
          
          # Run Python security checks
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('main.json', 'r') as f:
                  template = json.load(f)
              
              issues = []
              warnings = []
              
              for resource in template.get('resources', []):
                  resource_type = resource.get('type', '')
                  properties = resource.get('properties', {})
                  
                  # Storage account security
                  if 'Microsoft.Storage/storageAccounts' in resource_type:
                      if not properties.get('supportsHttpsTrafficOnly', True):
                          issues.append('Storage account allows HTTP traffic')
                      
                      if properties.get('minimumTlsVersion') != 'TLS1_2':
                          warnings.append('Storage account should use TLS 1.2 minimum')
                      
                      if 'encryption' not in properties:
                          issues.append('Storage account missing encryption configuration')
                  
                  # Function App security
                  if 'Microsoft.Web/sites' in resource_type:
                      if not properties.get('httpsOnly', True):
                          issues.append('Function App should be HTTPS only')
                      
                      site_config = properties.get('siteConfig', {})
                      if site_config.get('minTlsVersion') != '1.2':
                          warnings.append('Function App should use TLS 1.2 minimum')
              
              if warnings:
                  print('⚠️ Security warnings:')
                  for warning in warnings:
                      print(f'  - {warning}')
              
              if issues:
                  print('❌ Security issues found:')
                  for issue in issues:
                      print(f'  - {issue}')
                  sys.exit(1)
              else:
                  print('✅ No critical security issues found')
                  
          except FileNotFoundError:
              print('❌ main.bicep not found or failed to build')
              sys.exit(1)
          except Exception as e:
              print(f'❌ Error: {e}')
              sys.exit(1)
          EOF
          
      # 4. HARDCODED SECRETS CHECK
      - name: Hardcoded Secrets Check
        run: |
          echo "=== Checking for Hardcoded Secrets ==="
          
          # Search for potential secrets
          FOUND_ISSUES=0
          
          # Check Bicep files
          echo "Checking Bicep files..."
          for file in $(find . -name "*.bicep" -type f); do
            echo "Checking: $file"
            
            # Look for hardcoded values
            if grep -q "password\|secret\|key\|token" "$file"; then
              echo "❌ Found potential hardcoded value in: $file"
              grep -n "password\|secret\|key\|token" "$file"
              FOUND_ISSUES=1
            fi
          done
          
          if [ $FOUND_ISSUES -eq 0 ]; then
            echo "✅ No hardcoded secrets found in Bicep files"
          else
            echo "❌ Hardcoded values found. Use parameters or Azure Key Vault."
            exit 1
          fi